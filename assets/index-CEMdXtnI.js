import{F as Ye,A as ut,V as d,R as Jt,D as re,a as We,L as fe,c as ft,S as Xt,C as Me,P as Zt,W as Qt,b as qt,G as eo,d as to,M as Rt,e as oo,f as It,O as no,g as io,h as mt,i as so,I as ao,j as Xe}from"./vendor-wANzw8Mv.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function o(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=o(i);fetch(i.href,a)}})();let pe,U=[];const H=new Jt,$=.65,Ve=.5,T=new d;new d;const W=[];new d;const Ot=new d(0,-1,0);function ro(t,e){new Ye().load(t,n=>{pe=n,pe.scale.set(.0425,.0425,.0425),pe.position.set(5,-9.25,0),U=[],pe.traverse(i=>{i.isMesh&&(i.material&&(Array.isArray(i.material)?i.material.forEach(a=>{a.visible=!1,a.opacity=0,a.transparent=!0}):(i.material.visible=!1,i.material.opacity=0,i.material.transparent=!0)),U.push(i))}),console.log(`Added ${U.length} meshes for collision detection`),e&&e(pe)})}function X(t,e,o){return U.length===0?!1:(H.set(t,e),H.far=o+Ve,W.length=0,H.intersectObjects(U,!0,W),W.length>0&&W[0].distance<o+Ve)}function se(t,e){if(U.length===0||e.length()===0)return e;e.length();const o=e.clone(),n=t.clone();if(T.copy(e).normalize(),X(n,T,$))return o.set(0,0,0),o;const i=Math.PI/6,a=Math.PI/3,r=Math.PI/2;T.copy(e).normalize();const c=new d().copy(T);c.applyAxisAngle(new d(0,1,0),-i),X(n,c,$*.85)&&(o.x-=o.x*.9,o.z-=o.z*.9),T.copy(e).normalize();const f=new d().copy(T);f.applyAxisAngle(new d(0,1,0),i),X(n,f,$*.85)&&(o.x-=o.x*.9,o.z-=o.z*.9),T.copy(e).normalize();const u=new d().copy(T);u.applyAxisAngle(new d(0,1,0),-a),X(n,u,$*.75)&&(o.x-=o.x*.8,o.z-=o.z*.8),T.copy(e).normalize();const p=new d().copy(T);p.applyAxisAngle(new d(0,1,0),a),X(n,p,$*.75)&&(o.x-=o.x*.8,o.z-=o.z*.8),T.copy(e).normalize();const A=new d().copy(T);A.applyAxisAngle(new d(0,1,0),-r),X(n,A,$*.7)&&(o.x-=o.x*.7,o.z-=o.z*.7),T.copy(e).normalize();const V=new d().copy(T);return V.applyAxisAngle(new d(0,1,0),r),X(n,V,$*.7)&&(o.x-=o.x*.7,o.z-=o.z*.7),o}function lo(t,e){const o=[];for(let c=0;c<5;c++){const f=new ut(new d(1,0,0),new d(0,0,0),$+Ve,16711680);t.add(f),o.push(f)}const i=new ut(new d(0,-1,0),new d(0,0,0),10,65535);t.add(i),o.push(i);function a(){if(!e)return;const c=new d;e.getWorldPosition(c),c.y+=.5;for(let p=0;p<5;p++){const A=p/5*Math.PI*2,V=new d(Math.sin(A),0,Math.cos(A)).normalize();o[p].position.copy(c),o[p].setDirection(V),H.set(c,V);const g=H.intersectObjects(U,!0);g.length>0&&g[0].distance<$+Ve?(o[p].setColor(16711680),o[p].setLength(g[0].distance)):(o[p].setColor(65280),o[p].setLength($+Ve))}const f=o[5];f.position.copy(c),H.set(c,Ot);const u=H.intersectObjects(U,!0);u.length>0&&u[0].distance<10?(f.setColor(65535),f.setLength(u[0].distance)):(f.setColor(16711935),f.setLength(10))}function r(c){o.forEach(f=>{f.visible=c})}return{update:a,setVisible:r}}function ae(t,e=10,o=1.7){if(U.length===0)return null;const n=t.clone();return n.y+=.5,H.set(n,Ot),H.far=e,W.length=0,H.intersectObjects(U,!0,W),W.length>0?W[0].point.y:null}const pt=new Ye;class co{constructor(e,o,n=0){this.scene=e,this.position=new d(o.x,0,o.z),this.rotation=n,this.health=3,this.isAlive=!0,this.isAnimating=!1,this.model=null,this.brokenModel=null,this.mixer=null,this.loadModels()}loadModels(){pt.load("./models/zombiecutout.fbx",e=>{this.model=e,this.model.position.copy(this.position),this.model.rotation.y=this.rotation,this.model.scale.set(.014,.014,.014),this.model.traverse(o=>{o.isMesh&&(o.castShadow=!0,o.receiveShadow=!0,o.material&&(Array.isArray(o.material)?o.material.forEach(n=>{n.side=re,n.roughness=1,n.metalness=0}):(o.material.side=re,o.material.roughness=1,o.material.metalness=0)))}),this.scene.add(this.model),this.position.y+=.1,this.model.position.copy(this.position),pt.load("./models/zombiecutoutbroken.fbx",o=>{if(this.brokenModel=o,this.brokenModel.position.copy(this.position),this.brokenModel.rotation.y=this.rotation,this.brokenModel.scale.set(.014,.014,.014),this.brokenModel.traverse(n=>{n.isMesh&&(n.castShadow=!0,n.receiveShadow=!0,n.material&&(Array.isArray(n.material)?n.material.forEach(i=>{i.side=re,i.roughness=1,i.metalness=0}):(n.material.side=re,n.material.roughness=1,n.material.metalness=0)))}),this.mixer=new We(this.brokenModel),this.brokenModel.animations.length>0){const n=this.mixer.clipAction(this.brokenModel.animations[0]);n.setLoop(fe),n.clampWhenFinished=!0,this.fallAnimation=n}this.brokenModel.visible=!1,this.scene.add(this.brokenModel)})})}isInHitRange(e,o=2){return!this.model||!this.isAlive?!1:new d().copy(this.position).sub(e).length()<=o}hit(){return!this.isAlive||this.isAnimating?!1:(this.health--,this.health>0?(this.applyHitReaction(),!0):(this.knockDown(),!0))}applyHitReaction(){if(!this.model)return;this.model.rotation.y;const e=Math.random()*.2-.1;this.model.rotation.z+=e,this.isAnimating=!0,setTimeout(()=>{if(this.model){const n=Date.now(),i=this.model.rotation.z,a=setInterval(()=>{const r=Date.now()-n,c=Math.min(r/300,1);this.model.rotation.z=i*(1-c),c>=1&&(clearInterval(a),this.isAnimating=!1)},16)}},100)}knockDown(){!this.model||!this.brokenModel||(this.isAlive=!1,this.isAnimating=!0,this.model.visible=!1,this.brokenModel.visible=!0,this.fallAnimation?(this.fallAnimation.reset(),this.fallAnimation.play(),this.mixer.addEventListener("finished",()=>{this.isAnimating=!1})):setTimeout(()=>{this.isAnimating=!1},1e3))}reset(){this.health=3,this.isAlive=!0,this.isAnimating=!1,this.model&&this.brokenModel&&(this.model.visible=!0,this.model.rotation.z=0,this.brokenModel.visible=!1,this.fallAnimation&&this.fallAnimation.stop())}update(e){this.mixer&&this.isAnimating&&this.mixer.update(e)}findGroundHeight(){return!0}remove(){this.model&&this.scene.remove(this.model),this.brokenModel&&this.scene.remove(this.brokenModel)}}function uo(t,e){const o=[];return e.forEach(n=>{const i=new co(t,new d(n.x,n.y,n.z),n.rotation||0);o.push(i)}),o}class fo{constructor(e,o="game_room"){this.serverUrl=e,this.roomName=o,this.client=null,this.room=null,this.$=null,this.callbacks={},this.playerListenersAttached=!1,this.initialStateProcessed=!1,console.log(`[multiplayer.js] MultiplayerManager initialized. Server: ${e}, Room: ${o}`)}setCallbacks(e){this.callbacks=e}assignCallbacks(e){if(!e||typeof e.onPlayerAdd!="function"||typeof e.onPlayerChange!="function"||typeof e.onPlayerRemove!="function"||typeof e.onError!="function")throw console.error("[multiplayer.js] assignCallbacks: Required player/error callbacks are missing or not functions.",e),new Error("Missing required multiplayer callbacks.");e.onConnect&&typeof e.onConnect!="function"&&console.warn("[multiplayer.js] assignCallbacks: Provided onConnect is not a function."),this.callbacks={...this.callbacks,...e},console.log("[multiplayer.js] Assigning callbacks:",this.callbacks)}async connect(){if(this.isConnected()){console.warn("[multiplayer.js] Already connected.");return}this.playerListenersAttached=!1,this.initialStateProcessed=!1;const{onConnect:e,onPlayerAdd:o,onPlayerChange:n,onPlayerRemove:i,onError:a}=this.callbacks;this.client=new ft.Client(this.serverUrl),console.log("[multiplayer.js] Connecting to multiplayer server...");try{if(!a)throw console.error("[multiplayer.js] connect: onError callback is not assigned. Cannot proceed safely."),new Error("onError callback must be assigned before connecting.");this.room=await this.client.joinOrCreate(this.roomName),this.$=ft.getStateCallbacks(this.room),console.log(`[multiplayer.js] Successfully joined room: ${this.room.name}`);const r=this.room.sessionId;console.log(`[multiplayer.js] My session ID: ${r}`),this._setupRoomListeners(),console.log("[multiplayer.js] Calling onConnect callback."),this.callbacks.onConnect?(console.log("[multiplayer.js] Calling onConnect callback."),e(r)):console.warn("[multiplayer.js] onConnect callback was not provided.")}catch(r){console.error("[multiplayer.js] Connection failed:",r),a?a(r.message||"An unknown connection error occurred."):console.error("[multiplayer.js] CRITICAL: Connection failed but onError callback is missing!"),this.cleanup()}}_setupRoomListeners(){if(!this.room){console.error("[multiplayer.js] _setupRoomListeners called but room is null.");return}console.log("[multiplayer.js] Setting up room listeners..."),this.room.onStateChange(e=>{!this.initialStateProcessed&&e.players&&e.players.size!==void 0?(console.log(`[multiplayer.js] onStateChange: First valid state with players map received (Size: ${e.players.size}). Processing initial players and attaching listeners...`),this.setupPlayerListeners(e),e.players.forEach((o,n)=>{console.log(`[multiplayer.js] Processing existing player from initial state: ${n}`);const i=o.toJSON();this.callbacks.onPlayerAdd&&this.callbacks.onPlayerAdd(n,i),this.attachIndividualPlayerListener(o,n)}),this.initialStateProcessed=!0,console.log("[multiplayer.js] Initial state processed and listeners attached.")):console.log("[multiplayer.js] onStateChange: State received, but players map not ready yet or doesn't exist.")}),console.log("[multiplayer.js] onStateChange listener attached."),console.log("[multiplayer.js] Attaching Room onError listener."),this.room.onError((e,o)=>{console.error(`[multiplayer.js] Room error (Code: ${e}):`,o),this.callbacks.onError&&this.callbacks.onError({code:e,message:o})}),console.log("[multiplayer.js] Room onError listener attached."),console.log("[multiplayer.js] Attaching Room onLeave listener."),this.room.onLeave(e=>{console.log(`[multiplayer.js] Left room (Code: ${e})`),this.initialStateProcessed=!1,this.playerListenersAttached=!1,this.room=null,e===1e3?console.log("[multiplayer.js] Normal disconnect."):(console.warn(`[multiplayer.js] Abnormal disconnect code: ${e}`),this.callbacks.onError&&this.callbacks.onError({code:e,message:`Disconnected with code ${e}`}))}),console.log("[multiplayer.js] Room onLeave listener attached.")}setupPlayerListeners(e){this.playerListenersAttached||(console.log("[multiplayer.js] setupPlayerListeners: Checking for players map in state:",e),e&&e.players&&this.$?(console.log(`[multiplayer.js] setupPlayerListeners: Players map found (Size: ${e.players.size}). Attaching listeners...`),this.$(e.players).onAdd((o,n)=>{console.log(`[multiplayer.js] Player ADDED via MapSchema.onAdd: ${n}`,o.toJSON()),this.attachIndividualPlayerListener(o,n),this.callbacks.onPlayerAdd&&this.callbacks.onPlayerAdd(n,o.toJSON())}),this.$(e.players).onRemove((o,n)=>{console.log(`[multiplayer.js] Player REMOVED via MapSchema.onRemove: ${n}`),this.callbacks.onPlayerRemove&&this.callbacks.onPlayerRemove(n)}),console.log("[multiplayer.js] setupPlayerListeners: Add/Remove Listeners attached successfully."),this.playerListenersAttached||(console.log("[multiplayer.js] setupPlayerListeners: Setting playerListenersAttached = true."),this.playerListenersAttached=!0)):console.warn("[multiplayer.js] setupPlayerListeners: Called, but state or state.players is missing. Cannot attach listeners yet."))}attachIndividualPlayerListener(e,o){!e||!this.$||this.$(e).onChange(()=>{console.log(`[multiplayer.js] Player CHANGED via NATIVE player.onChange: ${o}`,e.toJSON()),this.callbacks.onPlayerChange&&this.callbacks.onPlayerChange(o,e.toJSON())})}sendPlayerState(e){this.room&&this.isConnected()&&this.room.send("move",e)}sendAnimationUpdate(e){this.room&&this.isConnected()&&this.room.send("animation",{animationName:e})}sendJump(){this.room&&this.isConnected()&&this.room.send("jump")}sendMessage(e,o){if(this.room&&this.isConnected())try{return this.room.send(e,o),!0}catch(n){return console.error(`[multiplayer.js] Error sending message (${e}):`,n),!1}else return console.warn(`[multiplayer.js] Cannot send message (${e}), not connected to room.`),!1}isConnected(){return this.client!==null&&this.room!==null&&this.room.connection&&this.room.connection.isOpen}getSessionId(){return this.room?this.room.sessionId:null}cleanup(){console.log("[multiplayer.js] Cleaning up multiplayer connection."),this.room&&this.room.leave(),this.client=null,this.room=null,this.playerListenersAttached=!1,this.initialStateProcessed=!1}}let k=null;const S=new Xt;S.background=new Me(12571109);const w=new Zt(88,window.innerWidth/window.innerHeight,.1,1e3),B=new Qt({canvas:document.getElementById("bg"),antialias:!0});B.setSize(window.innerWidth,window.innerHeight);B.setPixelRatio(window.devicePixelRatio);B.shadowMap.enabled=!0;B.outputColorSpace=qt;document.body.appendChild(B.domElement);let Ie=ie()?5:1.77,Oe=ie()?5:2.14,$e=2.04;const _e=document.createElement("div");_e.style.cssText="position:absolute;top:4px;left:4px;color:#fff;background:rgba(0,0,0,0.5);padding:4px;font-size:12px;z-index:1000";document.body.appendChild(_e);const He=document.createElement("div");He.style.cssText="position:absolute;top:24px;left:4px;color:#fff;background:rgba(0,0,0,0.5);padding:4px;font-size:12px;z-index:1000";document.body.appendChild(He);const Ue=document.createElement("div");Ue.style.cssText="position:absolute;top:44px;left:4px;color:#fff;background:rgba(0,0,0,0.5);padding:4px;font-size:12px;z-index:1000";document.body.appendChild(Ue);const at=document.createElement("div");at.style.cssText="position:absolute; top:64px; left:4px; color:#fff; background:rgba(0,0,0,0.5); padding:4px; font-size:12px; z-index:1000; display: flex; flex-direction: column; gap: 2px;";document.body.appendChild(at);function rt(t,e,o){const n=document.createElement("div");n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center";const i=document.createElement("label");i.textContent=t+":",i.style.marginRight="5px";const a=document.createElement("input");return a.type="number",a.step="0.1",a.value=e.toFixed(2),a.style.cssText="width: 50px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid #555; padding: 1px 3px; font-size: 11px;",a.addEventListener("change",r=>{const c=parseFloat(r.target.value);isNaN(c)||o(c)}),a.addEventListener("input",r=>{const c=parseFloat(r.target.value);isNaN(c)||o(c)}),n.appendChild(i),n.appendChild(a),at.appendChild(n),a}rt("Distance",Ie,t=>{Ie=t});rt("HeightOff",Oe,t=>{Oe=t});rt("LookAtYOff",$e,t=>{$e=t});let ht=0;window.addEventListener("resize",()=>{w.aspect=window.innerWidth/window.innerHeight,w.updateProjectionMatrix(),B.setSize(window.innerWidth,window.innerHeight)});const ot=B.domElement;ot.addEventListener("click",()=>{ie()||ot.requestPointerLock()});function ie(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window}document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("mobile-controls");t?ie()?(console.log("[main.js] Mobile detected, showing controls."),t.style.display="block"):(console.log("[main.js] Desktop detected, hiding controls."),t.style.display="none"):console.warn("[main.js] Mobile controls container (#mobile-controls) not found.")});let he;const gt=new Ye,Ge=new eo,$t=new to;$t.setDecoderPath("./draco/");Ge.setDRACOLoader($t);ro("./models/mainmenu.fbx",t=>{console.log("Collision map loaded"),S.add(t)});let Ne,Z,me=new Map,we=0,Ze=0,yt=0;const mo=1e3;performance.now();let ve=!1,Vt=0;const po=50;let ke=0;function ho(t,e){if(k&&t===k.getSessionId()){console.log("[main.js] handlePlayerAdd: Ignoring call for local player.");return}console.log(`[main.js] handlePlayerAdd called for sessionId: ${t} with playerData:`,JSON.stringify(e));try{if(me.has(t)){console.log(`[main.js] Model for sessionId ${t} already exists, skipping`);return}const o=so(s);o.traverse(u=>{u.isMesh&&(u.castShadow=!0,u.receiveShadow=!0,u.material&&(Array.isArray(u.material)?u.material.forEach(p=>{p.color=new Me(16777215),p.roughness=.8,p.metalness=.1}):(u.material.color=new Me(16777215),u.material.roughness=.8,u.material.metalness=.1)))});const n=new We(o),i={};oe&&m&&Object.keys(m).forEach(u=>{const p=m[u];if(p){const A=p.getClip();i[u]=n.clipAction(A),(u==="punch"||u==="hit"||u==="jump")&&(i[u].clampWhenFinished=!1)}}),o.userData.mixer=n,o.userData.actions=i,i.idle&&i.idle.play(),o.userData.currentAnimation="idle",o.uuid=`player-${t}`,console.log(`[main.js] Cloned model for ${t}. Initial props: pos=${o.position.toArray().join(",")}, rot.y=${o.rotation.y.toFixed(2)}, scale=${o.scale.toArray().join(",")}, visible=${o.visible}`);const a=typeof e.x=="number"?e.x:0,r=typeof e.y=="number"?e.y:0,c=typeof e.z=="number"?e.z:0,f=typeof e.rotationY=="number"?e.rotationY:0;o.position.set(a,r,c),o.rotation.y=f,o.visible=!0,o.scale.set(.012,.012,.012),console.log(`[main.js] Model props AFTER setting from data: pos=${o.position.toArray().join(",")}, rot.y=${o.rotation.y.toFixed(2)}, scale=${o.scale.toArray().join(",")}, visible=${o.visible}`),console.log("[main.js] Model object before adding:",o),console.log(`[main.js] Scene children count BEFORE add: ${S.children.length}`),S.add(o),console.log(`[main.js] Scene children count AFTER add: ${S.children.length}`),console.log(`[main.js] Camera state: Pos=(${w.position.toArray().map(u=>u.toFixed(2)).join(",")}), Near=${w.near}, Far=${w.far}`),o.userData.targetPosition=new d().copy(o.position),o.userData.targetRotationY=o.rotation.y,me.set(t,o),console.log(`[main.js] Model added for sessionId ${t}`)}catch(o){console.error(`[main.js] Error adding player model for sessionId ${t}:`,o)}}function go(t,e){if(k&&t===k.getSessionId())return;console.log(`[DEBUG] Processing state change for REMOTE player: ${t}`,JSON.stringify(e));const o=me.get(t);if(!o){console.warn(`[main.js] Received change for unknown player model: ${t}`);return}if(console.log(`[DEBUG] Found model for ${t}`),o.userData.targetPosition||(console.log(`[DEBUG] Initializing targetPosition for ${t}`),o.userData.targetPosition=new d),e.x!==void 0&&e.y!==void 0&&e.z!==void 0&&(console.log(`[DEBUG] Updating targetPosition for ${t} to: x=${e.x}, y=${e.y}, z=${e.z}`),o.userData.targetPosition.set(e.x,e.y,e.z)),e.rotationY!==void 0&&(console.log(`[DEBUG] Updating targetRotationY for ${t} to: ${e.rotationY}`),o.userData.targetRotationY=e.rotationY),e.animation&&o.userData.actions&&o.userData.currentAnimation!==e.animation){console.log(`[DEBUG] Received animation update for ${t}: ${e.animation}`);const n=o.userData.currentAnimation,i=e.animation,a=o.userData.actions[n],r=o.userData.actions[i];if(r){a&&a.fadeOut(.2);const c=i==="punch"||i==="hit"||i==="jump"?fe:mt;if(r.reset().setLoop(c,1/0).setEffectiveWeight(1).setEffectiveTimeScale(1).fadeIn(.2).play(),c===fe&&(r.clampWhenFinished=!0),o.userData.currentAnimation=i,i==="punch"||i==="hit"){o.userData.animationTimeout&&(clearTimeout(o.userData.animationTimeout),o.userData.animationTimeout=null);const f=600;o.userData.animationTimeout=setTimeout(()=>{console.log(`[DEBUG] Auto-transitioning ${t} from ${i} back to idle`);const u=o.userData.actions[i],p=o.userData.actions.idle;u&&p&&o.userData.currentAnimation===i&&(u.fadeOut(.2),p.reset().setLoop(mt,1/0).setEffectiveWeight(1).fadeIn(.2).play(),o.userData.currentAnimation="idle")},f)}}else console.warn(`[main.js] Animation '${i}' not found for player ${t}`)}else e.animation&&!o.userData.actions&&console.warn(`[DEBUG] Received animation update for ${t} but otherModel.userData.actions is not ready.`)}function yo(t){console.log(`[main.js] handlePlayerRemove called for sessionId: ${t}`),console.log(`Removing player model for ${t}`);const e=me.get(t);e&&(S.remove(e),me.delete(t))}Ge.load("./models/lowpolybottomplaque.glb",t=>{const e=t.scene;e.position.set(9.36,1.11,-42.58),e.rotation.y=Math.PI*1.6,S.add(e)});Ge.load("./models/lowpolyinfosign1.glb",t=>{const e=t.scene;e.position.set(-2.51,.08,-1.9),e.rotation.y=Math.PI*.75,e.traverse(o=>{o.isMesh&&(console.log(`Processing banner mesh: ${o.name}`),o.castShadow=!0,o.receiveShadow=!0,(Array.isArray(o.material)?o.material:[o.material]).forEach(i=>{const a=new Rt({map:i.map,color:i.color?i.color:16777215,transparent:!0,alphaTest:.1,side:re,roughness:.7,metalness:.2});if(Array.isArray(o.material)){const r=o.material.indexOf(i);r!==-1&&(o.material[r]=a)}else o.material=a}))}),S.add(e),console.log("Info sign placed at X: -2.51, Y: 0.08, Z: -1.90")});Ge.load("./models/slobberzombienewrig.glb",t=>{if(console.log("Slobber zombie model loaded"),Z=t.scene,Z.position.set(8.29,1.08,-49.14),Z.scale.set(.5,.5,.5),Z.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),S.add(Z),console.log("Slobber zombie added to scene at position:",Z.position),Ne=new We(Z),t.animations&&t.animations.length>0){console.log(`Found ${t.animations.length} animations in the zombie model`);const e=Ne.clipAction(t.animations[0]);e.timeScale=.6,e.play(),t.animations.forEach((o,n)=>{console.log(`Animation ${n}: ${o.name}`)})}else console.warn("No animations found in the zombie model")},void 0,t=>{console.error("Error loading slobber zombie model:",t)});gt.load("./models/mainmenu.fbx",t=>{he=t,he.scale.set(.0425,.0425,.0425),he.position.set(5,-9.25,0),gt.load("./models/worldbanners.fbx",e=>{console.log("Worldbanners model loaded"),e.scale.set(.0425,.0425,.0425),e.position.set(5,-9.25,0),e.traverse(o=>{o.isMesh&&(console.log(`Processing banner mesh: ${o.name}`),o.castShadow=!1,o.receiveShadow=!0,(Array.isArray(o.material)?o.material:[o.material]).forEach(i=>{const a=new Rt({map:i.map,color:i.color?i.color:16777215,transparent:!0,alphaTest:.1,side:re,roughness:.7,metalness:.2});if(Array.isArray(o.material)){const r=o.material.indexOf(i);r!==-1&&(o.material[r]=a)}else o.material=a}))}),S.add(e)}),he.traverse(e=>{e.isMesh&&(e.receiveShadow=!0,e.castShadow=!0,e.material&&(Array.isArray(e.material)?e.material.forEach(o=>{o.color&&(o.color.getHex(),o.color.setHSL(o.color.getHSL({}).h,Math.min(o.color.getHSL({}).s*1.04,1),Math.min(o.color.getHSL({}).l*1.1,1))),o.roughness=.7,o.metalness=.25,o.envMapIntensity=1.2}):(e.material.color&&(e.material.color.getHex(),e.material.color.setHSL(e.material.color.getHSL({}).h,Math.min(e.material.color.getHSL({}).s*1.02,1),Math.min(e.material.color.getHSL({}).l*1.1,1))),e.material.roughness=.7,e.material.metalness=.25,e.material.envMapIntensity=1.2)))}),S.add(he)},void 0,t=>{console.error("Error loading main map model:",t)});const Vo=new oo(16774880,.5);S.add(Vo);const P=new It(16765578,1.15);P.position.set(15,25,15);P.castShadow=!0;P.target=new no;S.add(P.target);P.shadow.mapSize.width=256;P.shadow.mapSize.height=256;P.shadow.camera.near=.5;P.shadow.camera.far=50;P.shadow.camera.left=-20;P.shadow.camera.right=20;P.shadow.camera.top=20;P.shadow.camera.bottom=-20;P.shadow.bias=-5e-4;S.add(P);const _t=new It(12900338,.4);_t.position.set(-5,10,-10);S.add(_t);w.position.set(0,1,7);w.lookAt(0,2.75,0);let wt=0,Ht=new d;const wo=500,Ao=1;function bo(){s&&(P.position.x=s.position.x+15,P.position.z=s.position.z+15,P.target.position.copy(s.position),P.target.updateMatrixWorld(),P.shadow.needsUpdate=!0,Ht.copy(s.position))}function At(){if(!s)return;const t=Date.now(),e=t-wt,o=s.position.distanceTo(Ht)>Ao;(e>wo||o)&&(bo(),wt=t)}let oe,m={},O,s,bt=null;const Mt=new Ye;let J,ye=!1;const vt=new d,l={forward:!1,backward:!1,left:!1,right:!1};let nt=!1;new d;const Q=.08,xt=.003;let z=!1,ne=!1;const Mo=600,kt=1;function vo(t){return 1-(1-t)*(1-t)}function xo(t){return t*t}const Ut=.3,ko=.3;let St=Ut,Pt=0,Nt=0;const Ft=64;let G=0,Qe=0;const Fe=Math.PI/3;let Et=.7,Bt=0;const So=300;let R=0,Le=0,L=0,F=0,Po=-.48,Dt=0,Eo=200;function K(t){for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=Math.PI*2;return t}document.addEventListener("mousemove",t=>{if(document.pointerLockElement===ot){const e=-t.movementX*xt*Et,o=t.movementY*xt*Et,n=.1,i=Math.max(-.1,Math.min(n,e)),a=Math.max(-.1,Math.min(n,o));R+=i,Le+=a,R=K(R),Le=Math.max(-Fe,Math.min(Fe,Le))}});Mt.load("/models/ifindretards.fbx",t=>{s=t,s.scale.set(.012,.012,.012),s.position.set(0,0,0),s.rotation.y=Math.PI,s.traverse(n=>{n.isMesh&&(n.castShadow=!0,n.receiveShadow=!0,n.material&&(Array.isArray(n.material)?n.material.forEach(i=>{i.color=new Me(16777215),i.roughness=.8,i.metalness=.1}):(n.material.color=new Me(16777215),n.material.roughness=.8,n.material.metalness=.1)))}),S.add(s),oe=new We(s),oe.clock=new io,J=lo(S,s),J.setVisible(!1),Oo(),Ho(),$o();const e=[{name:"idle",file:"ifindretardsidle.fbx"},{name:"punch",file:"ifindretardspunching.fbx"},{name:"torso_punch",file:"ifindretardspunchingtorso.fbx"},{name:"walk",file:"ifindretardswalkinginplace.fbx"},{name:"strafe_left",file:"ifindretardsleftstrafe.fbx"},{name:"strafe_right",file:"ifindretardsrightstrafe.fbx"},{name:"hit",file:"ifindretardshitstomach.fbx"},{name:"jump",file:"ifindretardsjumpunarmed.fbx"}];let o=0;e.forEach(n=>{Mt.load(`/models/${n.file}`,i=>{const a=i.animations[0];if(n.name==="jump"){const r=[];for(let c=0;c<a.tracks.length;c++){const f=a.tracks[c];f.name.includes("_end_end_end")||r.push(f)}a.tracks=r}m[n.name]=oe.clipAction(a),(n.name==="punch"||n.name==="hit"||n.name==="jump")&&(m[n.name].clampWhenFinished=!0),o++,o===e.length&&Ke("idle")})})},void 0,t=>{console.error("Error loading main model:",t)});let Se=null,ee=null,Pe=null;const Do=512;let ce=[],Be=!1,je=!0;const Co=2.5,it={KeyA:0,KeyS:0,KeyD:0};let ge=null;const To=["mixamorigSpine","mixamorigSpine1","mixamorigSpine2","mixamorigNeck","mixamorigHead","mixamorigLeftShoulder","mixamorigLeftArm","mixamorigLeftForeArm","mixamorigLeftHand","mixamorigRightShoulder","mixamorigRightArm","mixamorigRightForeArm","mixamorigRightHand"];function zo(t,e=1,o=!1){if(!t||!s)return;const n=t.getClip().tracks;for(let i=0;i<n.length;i++){const r=n[i].name;To.some(f=>r.includes(f))?o?r.includes("Arm")||r.includes("Hand")?(r.includes("ForeArm")||r.includes("Hand"),t.getClip().tracks[i].weight=e*0):r.includes("Shoulder")||r.includes("Spine")?t.getClip().tracks[i].weight=e*0:(r.includes("Neck")||r.includes("Head"))&&(t.getClip().tracks[i].weight=e*1):r.includes("Arm")||r.includes("Hand")||r.includes("Shoulder")?t.getClip().tracks[i].weight=e*0:r.includes("Spine")||r.includes("Neck")?t.getClip().tracks[i].weight=e*.7:r.includes("Head")&&(t.getClip().tracks[i].weight=e*.5):r.includes("Hips")?t.getClip().tracks[i].weight=o?0:.3:t.getClip().tracks[i].weight=o?0:.05}}function Lo(t){if(!je){console.log("Punch rejected: Previous punch animation not complete");return}const o=ee===m.walk&&t==="punch"?"torso_punch":t;if(!m[o])return;Pe&&(clearTimeout(Pe),Pe=null);const n=m[o],i=o==="torso_punch",a=i?.14:.17,r=i?3:2.5,c=i?1.4:1.8;if(n.reset().setLoop(fe,1).setEffectiveWeight(r).fadeIn(a).play(),n.timeScale=c,n.interpolationType=ao,zo(n,2.8,i),n.clampWhenFinished=!0,Be=!0,je=!1,Uo(),(o==="punch"||o==="torso_punch")&&s){const f=new d(0,0,1).applyAxisAngle(new d(0,1,0),s.rotation.y),u=.1,p=6,A=300/p,V=u/p;for(let g=0;g<p;g++)setTimeout(()=>{s&&s.position.addScaledVector(f,V)},g*A)}Se=n,ve&&k&&k.isConnected()&&k.sendMessage("animation",{animation:o}),Pe=setTimeout(()=>{if(Se){const f=o==="torso_punch"?.512:.08;Se.fadeOut(f),setTimeout(()=>{Se=null,Be=!1,je=!0,console.log("Punch animation fully complete, ready for next punch")},o==="torso_punch"?512:80)}},Do)}function Y(t){if(ee===m[t])return;const e=ee;ee=m[t],e&&e.fadeOut(.2),ee&&ee.reset().setEffectiveWeight(1).fadeIn(.2).play(),t!==bt&&ve&&k&&k.isConnected()&&(k.sendMessage("animation",{animation:t}),bt=t)}function Ke(t,e=!1){if(t==="punch"||t==="hit")Lo(t);else if(t==="walk"||t==="idle"||t==="strafe_left"||t==="strafe_right")Y(t),O=m[t];else if(t==="jump"){if(e)return;O&&O!==m[t]&&O.fadeOut(.1),m[t]&&(m[t].reset().setLoop(fe,1).setEffectiveTimeScale(.5).setEffectiveWeight(.7).fadeIn(.1).play(),m[t].clampWhenFinished=!0,O=m[t])}ve&&k&&k.isConnected()&&k.sendMessage("animation",{animation:t})}let Ee=null;function jo(t){if(!s)return;const e=performance.now();L=I(L,R,.2),F=I(F,Le,.075),new d(s.position.x,0,s.position.z);const n=performance.now();if(ne&&!z&&n-Nt>=Ft){ne=!1,z=!0,Pt=n,Bt=n;const b=l.forward||l.backward||l.left||l.right;St=b?ko:Ut,console.log(`Jump initiated after preparation. Max height: ${St} (${b?"moving":"stationary"})`),s&&(G=s.position.y,Qe=G),m.jump&&(m.jump.timeScale=.5)}if(z){const g=e-Pt,b=Math.min(g/Mo,1);let v=b<.5?vo(b*2)*kt:xo((1-b)*2)*kt;const y=new d;w.getWorldDirection(y),y.y=0,y.normalize();const E=y.clone().cross(new d(0,1,0)).normalize(),j=new d;if(l.forward&&j.add(y),l.backward&&j.sub(y),l.left&&j.sub(E),l.right&&j.add(E),j.length()>0){j.normalize();const C=j.clone().multiplyScalar(Q*t*60),x=se(s.position.clone(),C);s.position.x+=x.x,s.position.z+=x.z}const M=Qe+v,D=ae(s.position)??Qe;if(b>=1||b>.5&&M<=D+.1){if(s.position.y=D,z=!1,ne=!1,m.jump&&(O===m.jump||!O)){const C=l.forward||l.backward||l.left||l.right,x=C?"walk":"idle";m[x]&&(m[x].reset(),m.jump.crossFadeTo(m[x],.2,!1),O=m[x],ee=m[x],C&&x==="walk"&&(l.backward&&!l.left&&!l.right?m.walk.timeScale=-.7:m.walk.timeScale=.77),console.log(`Jump landed, transitioning to ${x} animation`))}}else s.position.y=M;s.rotation.y=I(s.rotation.y,R+Math.PI,.1),J&&J.update();return}K(L);const i=new d;w.getWorldDirection(i),i.y=0,i.normalize();const a=i.clone().cross(new d(0,1,0)).normalize(),r=l.forward&&l.left&&!l.right,c=l.forward&&l.right&&!l.left;if((r||c)&&!nt){Y(r?"strafe_left":"strafe_right");const g=Math.atan2(i.x,i.z);s.rotation.y=I(s.rotation.y,g,.14);const v=i.clone().add(r?a.clone().negate():a.clone()).normalize().multiplyScalar(Q*.87*t*60),y=se(s.position,v);if(s.position.x+=y.x,s.position.z+=y.z,!z){const E=ae(s.position);E!==null&&(s.position.y=E+.05)}return}if(l.backward&&l.left&&l.right){const g=performance.now();ge||(ge=g),ge&&g-ge>=500?(l.left=!1,l.right=!1):it.KeyA>it.KeyD?l.right=!1:l.left=!1}else ge=null;const f=l.backward&&l.left&&!l.right,u=l.backward&&l.right&&!l.left;if(f||u){Y("walk");const g=K(L+Math.PI);s.rotation.y=I(s.rotation.y,g,.14),m.walk&&(m.walk.timeScale=-.5);const v=i.clone().negate().add(f?a.clone().negate():a.clone()).normalize().multiplyScalar(Q*.55*t*60),y=se(s.position,v);if(s.position.x+=y.x,s.position.z+=y.z,!z){const E=ae(s.position);E!==null&&(s.position.y=E+.05,G=s.position.y)}return}const p=l.left&&!l.right&&!l.forward&&!l.backward,A=l.right&&!l.left&&!l.forward&&!l.backward;if((p||A)&&!nt){Y(p?"strafe_left":"strafe_right");const b=Math.atan2(i.x,i.z);s.rotation.y=I(s.rotation.y,b,.14);const v=p?a.clone().negate():a.clone();v.multiplyScalar(Q*.8*t*60);const y=se(s.position,v);if(s.position.x+=y.x,s.position.z+=y.z,!z){const E=ae(s.position);E!==null&&(s.position.y=E+.05)}return}let V=new d(0,0,0);if(l.forward&&V.add(i),l.backward&&V.sub(i),l.right&&V.add(a),l.left&&V.sub(a),V.length()>0){V.normalize();const g=m.walk?Math.abs(m.walk.timeScale):1;vt.set(V.x*Q*g*t*60,0,V.z*Q*g*t*60);const b=se(s.position,vt);if(s.position.x+=b.x,s.position.z+=b.z,!z){const v=ae(s.position);v!==null&&(s.position.y=v+.05,G=s.position.y)}if(l.backward&&!l.left&&!l.right){const v=K(L+Math.PI);s.rotation.y=I(s.rotation.y,v,.14),Y("walk"),Ee=null,m.walk&&(m.walk.timeScale=-.5),s.position.x-=b.x,s.position.z-=b.z;const y=i.clone().negate().multiplyScalar(Q*.55*t*60),E=se(s.position,y);s.position.x+=E.x,s.position.z+=E.z}else{const v=Math.atan2(V.x,V.z);if(s.rotation.y=I(s.rotation.y,v,.14),Y("walk"),m.walk){const y=performance.now();Ee===null&&(Ee=y);const E=y-Ee,j=Math.min(E/3200,1);m.walk.timeScale=.65+.23*j}}}else Y("idle")}function I(t,e,o){t=K(t),e=K(e);let n=e-t;n>Math.PI&&(n-=Math.PI*2),n<-Math.PI&&(n+=Math.PI*2);const i=.2,a=n*o,r=Math.max(-.2,Math.min(i,a));return K(t+r)}function Ro(){J&&(ye=!ye,J.setVisible(ye),console.log("Collision debug:",ye?"enabled":"disabled"))}function Io(){return je}window.addEventListener("keydown",t=>{(t.code==="KeyA"||t.code==="KeyS"||t.code==="KeyD")&&(it[t.code]=performance.now()),t.code==="KeyW"&&(l.forward=!0),t.code==="KeyS"&&(l.backward=!0),t.code==="KeyA"&&(l.left=!0),t.code==="KeyD"&&(l.right=!0);const e=performance.now();if(t.code==="Space"&&!z&&!ne&&e-Bt>=So){ne=!0,Nt=performance.now(),G=s.position.y;const o=ae(s.position);if(o!==null&&(G=o),console.log("Jump preparation started"),O&&O.fadeOut(.15),m.jump.reset().setLoop(fe,1).setEffectiveTimeScale(.15).setEffectiveWeight(.7).fadeIn(.15).play(),m.jump.clampWhenFinished=!0,O=m.jump,s){const a=Ft/3,r=.1/3;for(let c=0;c<3;c++)setTimeout(()=>{s&&ne&&(s.position.y-=r)},c*a)}}t.code==="KeyF"&&Ke("hit",!0),t.code==="KeyC"&&Ro()});window.addEventListener("keyup",t=>{t.code==="KeyW"&&(l.forward=!1),t.code==="KeyS"&&(l.backward=!1),t.code==="KeyA"&&(l.left=!1),t.code==="KeyD"&&(l.right=!1),!l.forward&&!l.backward&&!l.left&&!l.right&&!z&&!ne&&Y("idle")});window.addEventListener("mousedown",t=>{t.button===0&&Io()&&Ke("punch",!0)});if(ie()){let g=function(){u=t.getBoundingClientRect(),p=u.width/2,A=u.height/2,V=u.width/3,console.log("Joystick dimensions updated:",u.width,u.height)},b=function(){const M=c-p,D=f-A,C=Math.abs(M),x=Math.abs(D),Je=C+x-Math.min(C,x)/2;let xe=M,ct=D;if(Je>V){const dt=V/Je;xe=M*dt,ct=D*dt}e.style.transform=`translate3d(calc(-50% + ${xe}px), calc(-50% + ${ct}px), 0)`},v=function(){const M=c-p,D=f-A,C=Math.abs(M),x=Math.abs(D);if(C+x-Math.min(C,x)/2>10){const xe=C>x;l.forward=l.backward=l.left=l.right=!1,xe?M>0?l.right=!0:l.left=!0:D>0?l.backward=!0:l.forward=!0}};console.log("Mobile device detected, initializing touch controls"),document.getElementById("mobile-controls").style.display="block";const t=document.getElementById("joystick-zone"),e=document.getElementById("joystick-thumb"),o=document.getElementById("attack-button"),n=document.getElementById("jump-button");let i=!1,a=0,r=0,c=0,f=0,u=t.getBoundingClientRect(),p=u.width/2,A=u.height/2,V=u.width/3;window.addEventListener("orientationchange",()=>{setTimeout(g,300)}),window.addEventListener("resize",()=>{g()}),t.addEventListener("touchstart",M=>{M.preventDefault();const D=M.touches[0];a=D.clientX-u.left,r=D.clientY-u.top,c=a,f=r,i=!0,nt=!0,b(),v()},{passive:!1});let y=0;const E=16;t.addEventListener("touchmove",M=>{if(!i)return;M.preventDefault();const D=performance.now();if(D-y<E)return;y=D;const C=M.touches[0],x=t.getBoundingClientRect();c=C.clientX-x.left,f=C.clientY-x.top,b(),v()},{passive:!1});const j=M=>{M.preventDefault(),i=!1,e.style.transform="translate(-50%, -50%)",l.forward=l.backward=l.left=l.right=!1};t.addEventListener("touchend",j,{passive:!1}),t.addEventListener("touchcancel",j,{passive:!1}),o.addEventListener("touchstart",M=>{M.preventDefault(),Ke("punch",!0)},{passive:!1}),n.addEventListener("touchstart",M=>{M.preventDefault(),window.dispatchEvent(new KeyboardEvent("keydown",{code:"Space"}))},{passive:!1})}function Oo(){s&&(w.position.set(0,1,7),w.lookAt(s.position.x,s.position.y+1.75,s.position.z))}async function $o(){console.log("[main.js] Initializing multiplayer connection...");const t="ws://localhost:2567";console.log("[main.js] Server URL:",t),k=new fo(t),k.assignCallbacks({onConnect:_o,onPlayerAdd:ho,onPlayerChange:go,onPlayerRemove:yo,onError:Xo});try{await k.connect()}catch(e){console.error("[main.js] Error connecting to multiplayer server:",e),ve=!1,k=null}}function _o(t){console.log(`[main.js] Successfully connected to multiplayer! My Session ID: ${t}`),ve=!0}function Ho(){const t=[{x:8,y:-9,z:-5,rotation:Math.PI*.75},{x:2,y:-9,z:-8,rotation:Math.PI*.5},{x:-5,y:-9,z:-2,rotation:Math.PI*.25},{x:-3,y:-9,z:5,rotation:0},{x:10,y:-9,z:3,rotation:Math.PI}];ce=uo(S,t),console.log(`Created ${ce.length} zombie targets`)}function Uo(){if(!s||!Be)return;const t=s.position.clone(),e=new d(0,0,-1).applyAxisAngle(new d(0,1,0),s.rotation.y),o=t.clone().add(e.multiplyScalar(1.5));ce.forEach(n=>{n.isInHitRange(o,Co)&&n.hit()&&console.log("Hit zombie target!")}),setTimeout(()=>{Be=!1},200)}const Ct=.15;let De=new d,qe=0;const No=60,Tt=1e3/No;let Ce={left:!1,right:!1};function Fo(t,e){ye&&J&&J.update(),e-ht>100&&(_e&&(_e.textContent=`Yaw: ${L.toFixed(2)}, Pitch: ${F.toFixed(2)}`),He&&s&&(He.textContent=`X: ${s.position.x.toFixed(2)}, Y: ${s.position.y.toFixed(2)}, Z: ${s.position.z.toFixed(2)}`),ht=e),we++,e-Ze>mo&&(yt=Math.round(we*1e3/(e-Ze)),we=0,Ze=e,Ue&&(Ue.textContent=`FPS: ${yt}`))}function Bo(t){ce&&ce.length>0&&ce.forEach(e=>{e&&e.update(t)}),Ne&&Ne.update(t)}function Yo(t){if(oe){const e=oe.clock.getDelta();oe.update(e)}jo(t)}function Wo(t){me.forEach(e=>{e.userData.mixer&&e.userData.mixer.update(t);const o=.15;e.userData.targetPosition&&e.position.lerp(e.userData.targetPosition,o),e.userData.targetRotationY!==void 0&&(e.rotation.y=I(e.rotation.y,-e.userData.targetRotationY+Math.PI,o))})}function Go(t){if(k&&k.isConnected()&&s){const e={x:s.position.x,y:s.position.y,z:s.position.z,rotationY:s.rotation.y},o=t-Vt>po&&(!s.userData.lastSentPos||Math.abs(e.x-s.userData.lastSentPos.x)>.001||Math.abs(e.y-s.userData.lastSentPos.y)>.001||Math.abs(e.z-s.userData.lastSentPos.z)>.001||Math.abs(e.rotationY-s.userData.lastSentPos.rotationY)>.01);ke===0&&(ke=t,console.log(`[Network] Initializing lastTimedNetworkUpdate to ${t}`));const n=t-ke,i=n>2e3;we%60===0&&console.log(`[Network] Time since last timed update: ${n.toFixed(0)}ms, shouldSendTimedUpdate: ${i}`),(o||i)&&(o&&console.log("[Network] Sending movement update (movement detected)"),i&&console.log("[Network] Sending timed update (2s interval)"),k.sendMessage("move",e)?(console.log("[Network] Update sent successfully"),s.userData.lastSentPos={...e},o&&(Vt=t),i&&(ke=t,console.log(`[Network] Updated lastTimedNetworkUpdate to ${t}`))):console.warn("[Network] Failed to send update"))}}function Ko(t){if(s)if(ie()){const e=Ie,o=Oe,n=$e,a=s.rotation.y+Math.PI,r=performance.now();(l.left!==Ce.left||l.right!==Ce.right)&&(Dt=r,Ce.left=l.left,Ce.right=l.right),r-Dt>Eo&&(R=I(R,a,.025)),l.left&&(R+=.008),l.right&&(R-=.008),R=K(R),L=I(L,R,.08);const f=z?G:s.position.y,u=new d(s.position.x,f+n,s.position.z);F=Po;const p=new d(Math.sin(L)*e,o,Math.cos(L)*e);De.lerp(u,Ct);const A=new d().copy(s.position).add(p);{const v=A.y>w.position.y?.005:.05;w.position.x=Xe.lerp(w.position.x,A.x,.15),w.position.z=Xe.lerp(w.position.z,A.z,.15),w.position.y=Xe.lerp(w.position.y,A.y,v),w.lookAt(De)}}else{const e=Ie,o=Oe,n=$e;F=Math.max(-Fe,Math.min(Fe,F)),new d(Math.sin(L)*e,o,Math.cos(L)*e);const i=new d(Math.sin(L)*Math.cos(F)*e,(z?0:Math.sin(F))*e+o,Math.cos(L)*Math.cos(F)*e),a=z?G:s.position.y;new d(s.position.x,a+n,s.position.z);const r=s.position.y+n,c=new d(s.position.x,r,s.position.z);De.lerp(c,Ct);const f=new d().copy(s.position).add(i),A=z?.08:.12;w.position.lerp(f,A),w.lookAt(De)}}function Jo(){(!ie()||we%10===0)&&typeof At=="function"&&At()}function Yt(t){requestAnimationFrame(Yt);const e=performance.now(),o=e-qe;if(o<Tt&&qe!==0)return;let n=Math.max(0,o/1e3);qe=e-o%Tt,n=Math.min(n,.1),Fo(n,e),Bo(n),Yo(n),Wo(n),Go(e),Ko(),Jo(),B&&S&&w&&B.render(S,w)}Yt();function Xo(t){console.error("[main.js] Multiplayer Error:",t)}const Zo=.44,Qo=.25,st=4*60*1e3,zt=15*1e3,qo=28*1e3,en=1,tn=.95,Lt=.15;let h=null,_=null,te=!1,Re=0,de=null,et=null,Ae=!1,q=[],Te=-1,ze=[];const on=3,nn=!0;let N=null;function jt(){const t=Math.random()*40+10;return Math.pow(2,t/1200)}function sn(){N=new Audio,N.src="./sfx/wind1.mp3",N.volume=.3,N.playbackRate=jt(),N.addEventListener("ended",()=>{N.playbackRate=jt(),N.currentTime=0,N.play()})}function Wt(){window.initAudioSystem=Wt;try{an(),rn(),document.addEventListener("click",tt,{once:!0}),document.addEventListener("keydown",tt,{once:!0}),document.addEventListener("touchstart",tt,{once:!0})}catch(t){console.error("Error initializing audio system:",t)}}function tt(){window._userHasInteracted=!0,h&&!te&&be();try{const t=new Audio;t.src="data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAA1N3aXRjaCBQbHVzIMKpIE5DSCBTb2Z0d2FyZQBUSVQyAAAABgAAAzIyMzUAVFNTRQAAAA8AAANMYXZmNTcuODMuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAATEFNRTMuMTAwVVVVVVVVVVVVVUxBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQsRbAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQMSkAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV",t.volume=.001,t.play().then(()=>{!Ae&&_&&lt()}).catch(e=>{console.error("Failed to play silent sound:",e)})}catch(t){console.error("Error creating silent sound:",t)}sn(),N.play()}function an(){try{h=new Audio;const t="./music/rvztheme1.mp3";h.src=t;const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);h.volume=e?Qo:Zo,h.preload="auto",h.addEventListener("ended",()=>{te=!1,Re=Date.now(),de&&clearTimeout(de),de=setTimeout(be,st)})}catch(t){console.error("Error initializing music player:",t)}}function rn(){try{q=["./vox/narrator1.mp3","./vox/narrator2.mp3","./vox/narrator3.mp3","./vox/narrator4.mp3","./vox/narrator5.mp3","./vox/narrator6.mp3","./vox/narrator7.mp3","./vox/narrator8.mp3","./vox/narrator9.mp3","./vox/narrator10weekend1.mp3"],_=new Audio,_.volume=en,_.addEventListener("ended",()=>{Ae=!1,Kt(),le()});const t=Math.floor(Math.random()*3e3)+2e3,e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),o=()=>{setTimeout(()=>{lt()},t)};if(e){const n=()=>{if(window._userHasInteracted){o();return}setTimeout(n,1e3)};n()}else o()}catch(t){console.error("Error initializing narration system:",t)}}function be(){try{const t=Date.now();if(Re>0&&t-Re<st){const e=st-(t-Re);de&&clearTimeout(de),de=setTimeout(be,e);return}if(!te&&h){h.currentTime=0;const e=()=>{document.body.addEventListener("click",()=>{},{once:!0})},o=h.play();o!==void 0?o.then(()=>{te=!0}).catch(n=>{console.error("Error playing music:",n),te=!1,n.name==="NotAllowedError"?e():setTimeout(be,5e3)}):h.paused?(console.error("Music failed to play (legacy browser)"),te=!1,setTimeout(be,5e3)):te=!0}}catch(t){console.error("Error in playMusic:",t)}}function le(){try{et&&clearTimeout(et);const t=Math.floor(Math.random()*(qo-zt+1))+zt;et=setTimeout(()=>{Math.random()<tn?lt():le()},t)}catch(t){console.error("Error scheduling narration:",t)}}function lt(){try{if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&!window._userHasInteracted){le();return}if(Ae){le();return}let e,o=0;const n=20;if(q.length===1)e=0;else{const a=[];for(let r=0;r<q.length;r++)r!==Te&&!ze.includes(r)&&a.push(r);if(a.length>0)e=a[Math.floor(Math.random()*a.length)];else do if(e=Math.floor(Math.random()*q.length),o++,o>=n){const r=Array.from({length:q.length},(c,f)=>f).filter(c=>c!==Te);r.length>0?e=r[Math.floor(Math.random()*r.length)]:e=Math.floor(Math.random()*q.length);break}while(e===Te)}Te=e,ze.push(e),ze.length>on&&ze.shift();const i=q[e];_.src=i,i.endsWith(".mp3")&&(_.type="audio/mpeg"),_.load(),_.addEventListener("canplaythrough",function a(){_.removeEventListener("canplaythrough",a)},{once:!0}),ln(),setTimeout(()=>{_.play().then(()=>{Ae=!0}).catch(a=>{console.error("Error playing narration:",a),Ae=!1,Kt(),le()})},500)}catch(t){console.error("Error playing random narration:",t),le()}}const Gt=500,ue=20;function ln(){try{if(h){h._originalVolume=h.volume;const t=h._originalVolume,e=Lt,o=(t-e)/ue,n=Gt/ue;let i=0;const a=setInterval(()=>{if(i++,i<=ue){const r=t-o*i;h.volume=Math.max(e,r)}else h.volume=e,clearInterval(a)},n)}}catch(t){console.error("Error lowering music volume:",t),h&&(h.volume=Lt)}}function Kt(){try{if(h&&h._originalVolume){const t=h.volume,e=h._originalVolume,o=(e-t)/ue,n=Gt/ue;let i=0;const a=setInterval(()=>{if(i++,i<=ue){const r=t+o*i;h.volume=Math.min(e,r)}else h.volume=e,clearInterval(a)},n)}}catch(t){console.error("Error restoring music volume:",t),h&&h._originalVolume&&(h.volume=h._originalVolume)}}window.addEventListener("load",Wt);
